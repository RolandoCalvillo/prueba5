<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Modular - CNCI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #2a6aff, #ff8500);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #4b5563;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #2a6aff;
            color: white;
            border-color: #2a6aff;
        }
        .criteria-button {
            transition: transform 0.3s ease;
        }
        .criteria-button.rotate {
            transform: rotate(180deg);
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .modal-content-lg {
            max-width: 800px;
            text-align: left;
        }
    </style>
</head>
<body>

    <div id="app" class="container">
        <!-- Contenido dinámico de la aplicación -->
    </div>

    <script>
        // Objeto para simular la base de datos de usuarios
        let usersDB = {};
        const localStorageKey = 'cnci_evaluation_data';
        
        // Nombres de los meses para las etiquetas de los gráficos y edición
        const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

        // Cargar datos desde localStorage al inicio
        function loadUsersFromLocalStorage() {
            const storedData = localStorage.getItem(localStorageKey);
            if (storedData) {
                try {
                    usersDB = JSON.parse(storedData);
                } catch (e) {
                    console.error("Error parsing data from localStorage", e);
                    // Si hay un error, inicializar con los datos por defecto
                    initializeDefaultUsers();
                }
            } else {
                initializeDefaultUsers();
            }
        }

        // Guardar datos en localStorage
        function saveUsersToLocalStorage() {
            localStorage.setItem(localStorageKey, JSON.stringify(usersDB));
        }
        
        // Inicializar usuarios por defecto
        function initializeDefaultUsers() {
            usersDB = {
                'admin': { role: 'admin' },
                'Usuario01': {
                    role: 'user',
                    data: {
                        name: 'José Pérez',
                        viciCode: 'vici-j01',
                        generalScore: 85,
                        callGoal: 75,
                        generalComments: 'Pedro, has demostrado un excelente desempeño este mes. Tu atención a los alumnos es destacable y sigues los procesos de manera consistente. Debes mejorar en los tiempos de respuesta para alcanzar los objetivos del equipo.',
                        categories: [{
                            id: 'retencion',
                            name: 'Retención',
                            emoji: '🤝',
                            score: 9.0,
                            comments: {
                                supervision: 'Se cumplió la meta de retención.',
                                quality: 'Excelentes habilidades de seguimiento.',
                            },
                            criteria: [
                                { name: 'Seguimiento a población morosa.', score: 10 },
                                { name: 'Total de bajas de alumnos con morosidad.', score: 8 },
                                { name: 'Uso adecuado y oportuno de la columna de retención de CRM...', score: 9 },
                                { name: 'Retención y bajas pagadas.', score: 9 },
                            ],
                            color: 'bg-indigo-200'
                        }, {
                            id: 'reincorporacion',
                            name: 'Reincorporación',
                            emoji: '🔄',
                            score: 7.0,
                            comments: {
                                supervision: 'Se logró una buena tasa de reingreso.',
                                quality: 'Área de oportunidad en la difusión de promociones.',
                            },
                            criteria: [
                                { name: 'Bajas por no pago.', score: 7 },
                                { name: 'Búsqueda y difusión de promociones.', score: 6 },
                                { name: 'Registro y seguimiento.', score: 8 },
                                { name: 'Cierre de prospectos.', score: 7 },
                            ],
                            color: 'bg-green-200'
                        }, {
                            id: 'procesos',
                            name: 'Procesos',
                            emoji: '⚙️',
                            score: 9.5,
                            comments: {
                                supervision: 'Manejo impecable de los procesos académicos.',
                                quality: 'Excelente organización y eficiencia.',
                            },
                            criteria: [
                                { name: 'Procesos académicos: Cambio de carrera y/o programa...', score: 10 },
                                { name: 'Documentación completa y correcta.', score: 9 },
                                { name: 'Trámites en tiempo y forma.', score: 9.5 },
                            ],
                            color: 'bg-purple-200'
                        }, {
                            id: 'comunicacion',
                            name: 'Comunicación',
                            emoji: '💬',
                            score: 8.5,
                            comments: {
                                supervision: 'Comunicación fluida con los alumnos y el equipo.',
                                quality: 'Mensajes claros y sin errores.',
                            },
                            criteria: [
                                { name: 'Redacción impecable y sin errores ortográficos.', score: 9 },
                                { name: 'Uso de canales formales.', score: 8 },
                                { name: 'Sinergia con otros departamentos.', score: 8.5 },
                            ],
                            color: 'bg-yellow-200'
                        }, {
                            id: 'administrativas',
                            name: 'Actividades Administrativas',
                            emoji: '📋',
                            score: 8.0,
                            comments: {
                                supervision: 'Registro de actividades consistente.',
                                quality: 'Mejorar la proactividad en guardias.',
                            },
                            criteria: [
                                { name: 'Registra en tiempo (diario) sus actividades en el reporte...', score: 9 },
                                { name: 'Asigna y actualiza perfiles.', score: 8 },
                                { name: 'Canaliza de manera óptima las situaciones...', score: 7 },
                            ],
                            color: 'bg-pink-200'
                        }, {
                            id: 'general',
                            name: 'General',
                            emoji: '📊',
                            score: 9.2,
                            comments: {
                                supervision: 'Desempeño general sobresaliente.',
                                quality: 'Excelente actitud y compromiso.',
                            },
                            criteria: [
                                { name: 'Productividad.', score: 9 },
                                { name: 'Calidad de trabajo.', score: 9.5 },
                                { name: 'Asertividad en la comunicación.', score: 9 },
                            ],
                            color: 'bg-gray-200'
                        }, {
                            id: 'whatsapp',
                            name: 'WhatsApp',
                            emoji: '📱',
                            score: 10.0,
                            comments: {
                                supervision: 'Manejo ejemplar de los chats.',
                                quality: 'Respuestas rápidas y asertivas.',
                            },
                            criteria: [
                                { name: 'Tiempos de respuesta óptimos.', score: 10 },
                                { name: 'Manejo de objeciones.', score: 10 },
                                { name: 'Redacción impecable.', score: 10 },
                            ],
                            color: 'bg-lime-200'
                        }],
                        trends: {
                            scores: {
                                'retencion': [85, 87, 88, 89, 90, 91, 88, 89, 92, 90, 89, 91],
                                'reincorporacion': [70, 75, 78, 80, 81, 85, 83, 82, 85, 86, 84, 87],
                                'procesos': [90, 92, 93, 94, 95, 96, 94, 95, 96, 97, 95, 98],
                                'general': [80, 82, 85, 86, 88, 89, 87, 89, 90, 88, 89, 90],
                            },
                            monthly: {
                                'month-2': { score: 90, trend: 'up' },
                                'month-1': { score: 91, trend: 'up' },
                                'current': { score: 92, trend: 'up' }
                            },
                            improvement: 'Incremento del 5% en la tasa de reincorporación, superando la meta del equipo.',
                            criticalArea: 'Mantener la agilidad en respuestas de WhatsApp durante picos de alta demanda.',
                        },
                        badges: [{
                            title: '🏆 Maestro(a) de Procesos',
                            description: 'Por su excelente manejo y seguimiento de los procesos académicos.'
                        }, {
                            title: '🚀 Asertividad Total',
                            description: 'Por su asertividad y claridad en la comunicación con los alumnos.'
                        }],
                        upcomingBadges: {
                            strengths: ['Excelencia en el seguimiento de procesos.', 'Capacidad de resolución de problemas.'],
                            opportunities: ['Incrementar la proactividad en guardias.', 'Mejorar los tiempos de respuesta en horarios pico.']
                        },
                        improvementPlan: {
                            instructions: 'Instrucciones para el Plan de Mejora. A partir de los resultados de tu evaluación, identifica de 3 a 4 áreas de oportunidad y describe acciones concretas que puedas implementar para mejorarlas. Indica el plazo estimado y cómo darás seguimiento a cada acción. Sé específico y realista para facilitar el cumplimiento y la evaluación de avances. Ingresa al siguiente enlace, redacta y establece tu plan de mejora antes del 11 de septiembre de 2025.',
                            link: 'https://www.google.com'
                        }
                    }
                },
                ...Array.from({ length: 17 }, (_, i) => {
                    const userNum = (i + 2).toString().padStart(2, '0');
                    const score = Math.floor(Math.random() * 20) + 70;
                    const categories = ['Retención', 'Reincorporación', 'Procesos', 'Comunicación', 'Actividades Administrativas', 'General', 'WhatsApp'];
                    return {
                        [`Usuario${userNum}`]: {
                            role: 'user',
                            data: {
                                name: `Usuario ${userNum}`,
                                viciCode: `vici-${userNum}`,
                                generalScore: score,
                                callGoal: Math.floor(Math.random() * 30) + 60,
                                generalComments: `Comentarios generales para el Usuario ${userNum}.`,
                                categories: categories.map(cat => ({
                                    id: cat.toLowerCase().replace(/\s+/g, ''),
                                    name: cat,
                                    emoji: '📊',
                                    score: (Math.random() * 5) + 5,
                                    comments: { supervision: `Comentario de Supervisión para ${cat}.`, quality: `Comentario de Calidad para ${cat}.` },
                                    criteria: [{ name: 'Criterio genérico 1', score: 8 }, { name: 'Criterio genérico 2', score: 9 }],
                                    color: 'bg-blue-200'
                                })),
                                trends: {
                                    scores: {
                                        'retencion': Array.from({ length: 12 }, () => Math.floor(Math.random() * 20) + 70),
                                        'reincorporacion': Array.from({ length: 12 }, () => Math.floor(Math.random() * 20) + 70),
                                        'procesos': Array.from({ length: 12 }, () => Math.floor(Math.random() * 20) + 70),
                                        'general': Array.from({ length: 12 }, () => Math.floor(Math.random() * 20) + 70),
                                    },
                                    monthly: {
                                        'month-2': { score: Math.floor(Math.random() * 20) + 70, trend: 'up' },
                                        'month-1': { score: Math.floor(Math.random() * 20) + 70, trend: 'down' },
                                        'current': { score: Math.floor(Math.random() * 20) + 70, trend: 'up' }
                                    },
                                    improvement: 'Mejora genérica.',
                                    criticalArea: 'Área crítica genérica.',
                                },
                                badges: [{ title: '🏅 Insignia Genérica', description: 'Descripción genérica.' }],
                                upcomingBadges: { strengths: ['Fortaleza genérica.'], opportunities: ['Oportunidad genérica.'] },
                                improvementPlan: {
                                    instructions: `Instrucciones para el Plan de Mejora para el Usuario ${userNum}.`,
                                    link: 'https://www.google.com'
                                }
                            }
                        }
                    }
                }).reduce((acc, obj) => ({ ...acc, ...obj }), {})
            };
            saveUsersToLocalStorage(); // Guardar los datos por defecto al inicializar
        }

        let currentUser = null;
        let chartInstance = null;
        const appContainer = document.getElementById('app');

        // Función para renderizar la pantalla de login
        function renderLogin() {
            appContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 bg-white/90 rounded-3xl shadow-lg w-full max-w-lg mx-auto">
                    <img src="https://i.ibb.co/m5QcyKWg/Logo-CNCI.png" alt="Logo CNCI" class="w-48 mb-6">
                    <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">Evaluación Modular – Departamento de Servicios Estudiantiles</h1>
                    <h2 class="text-xl font-semibold text-gray-600 mb-4">Módulo M8, Agosto 2025 🗓️</h2>
                    <p class="text-center text-gray-500 mb-6">Consulta tu desempeño del módulo de manera detallada ingresando tu usuario Vici.</p>
                    <div class="w-full flex flex-col items-center">
                        <input id="userInput" type="text" placeholder="Ingresa tu usuario" class="w-full px-4 py-3 mb-4 text-center text-lg border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
                        <button id="loginButton" class="w-full bg-[#2a6aff] hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all duration-300 hover:scale-105 active:scale-95">
                            Consultar mi Evaluación 🚀
                        </button>
                    </div>
                    <div id="message" class="mt-4 text-center text-sm font-semibold text-red-500"></div>
                </div>
            `;

            const userInput = document.getElementById('userInput');
            const loginButton = document.getElementById('loginButton');
            const messageDiv = document.getElementById('message');

            const handleLogin = () => {
                const user = userInput.value.trim();
                if (usersDB[user]) {
                    currentUser = usersDB[user];
                    if (currentUser.role === 'admin') {
                        renderAdminPanel();
                    } else {
                        renderDashboard();
                    }
                } else {
                    messageDiv.textContent = '❌ Usuario no encontrado. Por favor, revisa tu nombre de usuario.';
                    userInput.value = '';
                }
            };

            loginButton.addEventListener('click', handleLogin);
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });
        }

        // Función para renderizar el panel de administrador
        function renderAdminPanel() {
            appContainer.innerHTML = `
                <div class="bg-white/90 p-8 rounded-3xl shadow-lg w-full">
                    <div class="flex flex-wrap items-center justify-between mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Panel de Administrador ⚙️</h1>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                            <button id="backButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-300">
                                ← Volver al login
                            </button>
                            <button id="addUserButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-300">
                                Añadir Usuario
                            </button>
                            <button id="clearTableButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-300">
                                Vaciar Tabla
                            </button>
                        </div>
                    </div>
                    <div id="adminContent" class="space-y-4 overflow-x-auto">
                        <!-- Sección de Edición de Usuarios -->
                        <div class="p-6 bg-gray-100 rounded-2xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Edición de Usuarios</h2>
                            <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-lg">
                                <thead class="bg-gray-50">
                                    <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <th class="px-6 py-3 text-left">Usuario</th>
                                        <th class="px-6 py-3 text-left">Nombre</th>
                                        <th class="px-6 py-3 text-left">Puntaje General</th>
                                        <th class="px-6 py-3 text-left">Meta de Llamadas</th>
                                        <th class="px-6 py-3 text-left">Comentarios</th>
                                        <th class="px-6 py-3 text-left">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody" class="bg-white divide-y divide-gray-200 text-sm text-gray-700">
                                    <!-- Filas de usuarios se insertarán aquí -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Nueva Sección: Edición de Categorías y Criterios -->
                        <div class="p-6 bg-gray-100 rounded-2xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Edición de Categorías y Criterios de Evaluación</h2>
                            <p class="text-sm text-gray-600 mb-4">Los cambios realizados aquí se aplicarán a la plantilla de todos los usuarios.
                            </p>
                            <button id="editCategoriesButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-300">
                                Editar Categorías y Criterios
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de confirmación para vaciar tabla -->
                <div id="clearTableModal" class="modal-overlay hidden">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold mb-4">Confirmar Acción</h3>
                        <p class="mb-6">¿Estás seguro de que deseas eliminar TODOS los datos de la tabla? Esta acción es irreversible.</p>
                        <div class="flex justify-center space-x-4">
                            <button id="cancelClearButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl transition-all duration-300">
                                Cancelar
                            </button>
                            <button id="confirmClearButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl transition-all duration-300">
                                Eliminar Todo
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal para añadir/editar usuario (datos básicos) -->
                <div id="userModal" class="modal-overlay hidden">
                    <div class="modal-content max-w-2xl text-left">
                        <h3 id="modalTitle" class="text-xl font-bold mb-4">Añadir Nuevo Usuario</h3>
                        <form id="userForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-1">Usuario Vici</label>
                                <input type="text" id="viciUsername" required class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-1">Nombre Completo</label>
                                <input type="text" id="userName" required class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-1">Puntaje General</label>
                                <input type="number" id="generalScore" required min="0" max="100" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-1">Meta de Llamadas</label>
                                <input type="number" id="callGoal" required min="0" max="100" class="w-full p-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-gray-700 font-semibold mb-1">Comentarios Generales</label>
                                <textarea id="generalComments" required rows="3" class="w-full p-2 border border-gray-300 rounded-lg"></textarea>
                            </div>
                            <!-- Aquí se podrían añadir más campos para editar todas las propiedades -->
                            <div class="md:col-span-2 flex justify-end space-x-4 mt-4">
                                <button type="button" id="cancelUserButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl">Cancelar</button>
                                <button type="submit" id="saveUserButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Nuevo: Modal de detalles y edición completa del usuario -->
                <div id="detailsModal" class="modal-overlay hidden">
                    <div class="modal-content modal-content-lg max-h-[90vh] overflow-y-auto">
                        <h3 id="detailsModalTitle" class="text-2xl font-bold mb-6 text-center">Detalles del Usuario</h3>
                        <form id="detailsForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Sección de Datos Generales -->
                            <div class="md:col-span-2 p-4 bg-gray-100 rounded-xl">
                                <h4 class="font-bold text-lg mb-2">Datos Generales</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-semibold mb-1">Nombre</label><input type="text" id="detailsName" class="w-full p-2 border rounded-lg"></div>
                                    <div><label class="block text-sm font-semibold mb-1">Puntaje General</label><input type="number" id="detailsGeneralScore" class="w-full p-2 border rounded-lg"></div>
                                    <div><label class="block text-sm font-semibold mb-1">Meta de Llamadas</label><input type="number" id="detailsCallGoal" class="w-full p-2 border rounded-lg"></div>
                                    <div class="sm:col-span-2"><label class="block text-sm font-semibold mb-1">Comentarios Generales</label><textarea id="detailsGeneralComments" rows="3" class="w-full p-2 border rounded-lg"></textarea></div>
                                </div>
                            </div>
                            
                            <!-- Sección de Categorías -->
                            <div class="md:col-span-2 p-4 bg-gray-100 rounded-xl">
                                <h4 class="font-bold text-lg mb-4">Categorías y Criterios</h4>
                                <div id="detailsCategoriesContainer" class="space-y-4"></div>
                            </div>

                            <!-- Sección de Tendencias -->
                            <div class="md:col-span-2 p-4 bg-gray-100 rounded-xl">
                                <h4 class="font-bold text-lg mb-4">Tendencias (Valores de Gráfica)</h4>
                                <div class="grid grid-cols-1 gap-4" id="detailsTrendsContainer">
                                    <!-- Aquí se generarán los campos de edición para los valores de la gráfica -->
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                    <div><label class="block text-sm font-semibold mb-1">Mayor Mejora</label><input type="text" id="detailsImprovement" class="w-full p-2 border rounded-lg"></div>
                                    <div><label class="block text-sm font-semibold mb-1">Área Crítica</label><input type="text" id="detailsCriticalArea" class="w-full p-2 border rounded-lg"></div>
                                </div>
                            </div>

                            <!-- Sección de Insignias -->
                            <div class="md:col-span-2 p-4 bg-gray-100 rounded-xl">
                                <h4 class="font-bold text-lg mb-4">Insignias</h4>
                                <div id="detailsBadgesContainer" class="space-y-4"></div>
                            </div>

                            <!-- Sección de Plan de Mejora -->
                            <div class="md:col-span-2 p-4 bg-gray-100 rounded-xl">
                                <h4 class="font-bold text-lg mb-2">Plan de Mejora</h4>
                                <div><label class="block text-sm font-semibold mb-1">Instrucciones</label><textarea id="detailsImprovementInstructions" rows="3" class="w-full p-2 border rounded-lg"></textarea></div>
                                <div><label class="block text-sm font-semibold mb-1">Enlace</label><input type="url" id="detailsImprovementLink" class="w-full p-2 border rounded-lg"></div>
                            </div>

                            <!-- Botones de acción -->
                            <div class="md:col-span-2 flex justify-end space-x-4 mt-4">
                                <button type="button" id="cancelDetailsButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl">Cancelar</button>
                                <button type="submit" id="saveDetailsButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Nuevo Modal: Gestión de Categorías y Criterios -->
                <div id="categoryManagementModal" class="modal-overlay hidden">
                    <div class="modal-content modal-content-lg max-h-[90vh] overflow-y-auto">
                        <h3 class="text-2xl font-bold mb-6 text-center">Gestión de Categorías y Criterios</h3>
                        <div class="flex justify-end mb-4">
                            <button id="addCategoryButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl">Añadir Categoría</button>
                        </div>
                        <div id="categoriesList" class="space-y-4">
                            <!-- Las categorías se renderizarán aquí -->
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button id="closeCategoryModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl">Cerrar</button>
                        </div>
                    </div>
                </div>

                <!-- Nuevo Modal: Edición de una Categoría específica -->
                <div id="editCategoryModal" class="modal-overlay hidden">
                    <div class="modal-content modal-content-lg max-h-[90vh] overflow-y-auto">
                        <h3 id="editCategoryTitle" class="text-2xl font-bold mb-6 text-center"></h3>
                        <form id="editCategoryForm" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-1">Nombre de la Categoría</label>
                                <input type="text" id="categoryNameInput" class="w-full p-2 border rounded-lg" required>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-1">Emoji</label>
                                <input type="text" id="categoryEmojiInput" class="w-full p-2 border rounded-lg" maxlength="2">
                            </div>
                            <div class="mt-6 p-4 bg-gray-100 rounded-xl">
                                <h4 class="font-bold text-lg mb-2">Criterios de Evaluación</h4>
                                <div id="criteriaContainer" class="space-y-2">
                                    <!-- Los criterios se renderizarán aquí -->
                                </div>
                                <button type="button" id="addCriterionButton" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-xl text-sm">Añadir Criterio</button>
                            </div>
                            <div class="flex justify-end space-x-4 mt-6">
                                <button type="button" id="cancelEditCategoryButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl">Cancelar</button>
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Adjuntar event listeners
            document.getElementById('backButton').addEventListener('click', renderLogin);
            document.getElementById('clearTableButton').addEventListener('click', () => {
                document.getElementById('clearTableModal').classList.remove('hidden');
            });
            document.getElementById('cancelClearButton').addEventListener('click', () => {
                document.getElementById('clearTableModal').classList.add('hidden');
            });
            document.getElementById('confirmClearButton').addEventListener('click', clearAllUserData);
            document.getElementById('addUserButton').addEventListener('click', () => {
                showUserModal();
            });
            document.getElementById('editCategoriesButton').addEventListener('click', () => {
                showCategoryManagementModal();
            });
            
            // Añadir listeners para los botones del nuevo modal de detalles
            document.getElementById('cancelDetailsButton').addEventListener('click', () => {
                document.getElementById('detailsModal').classList.add('hidden');
            });

            renderUserTable();
        }
        
        // Función para renderizar la tabla de usuarios en el panel de admin
        function renderUserTable() {
            const userTableBody = document.getElementById('userTableBody');
            userTableBody.innerHTML = '';
            
            const userKeys = Object.keys(usersDB).filter(key => usersDB[key].role === 'user');
            
            userKeys.forEach(userKey => {
                const userData = usersDB[userKey].data;
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-100 transition-colors duration-200";
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${userKey}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${userData.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${userData.generalScore}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${userData.callGoal}</td>
                    <td class="px-6 py-4 max-w-xs truncate">${userData.generalComments}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="edit-btn text-indigo-600 hover:text-indigo-900 mr-2" data-user="${userKey}">Editar</button>
                        <button class="details-btn text-blue-600 hover:text-blue-900 mr-2" data-user="${userKey}">Detalles</button>
                        <button class="delete-btn text-red-600 hover:text-red-900" data-user="${userKey}">Eliminar</button>
                    </td>
                `;
                userTableBody.appendChild(row);
            });
            
            // Añadir listeners para los botones de editar, detalles y eliminar
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userKey = e.target.getAttribute('data-user');
                    showUserModal(userKey);
                });
            });
            
            document.querySelectorAll('.details-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userKey = e.target.getAttribute('data-user');
                    showDetailsModal(userKey);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userKey = e.target.getAttribute('data-user');
                    if (confirm(`¿Estás seguro de que deseas eliminar al usuario ${userKey}?`)) {
                        deleteUser(userKey);
                    }
                });
            });
        }
        
        // Función para mostrar el modal de usuario (añadir/editar datos básicos)
        function showUserModal(userKey = null) {
            const modal = document.getElementById('userModal');
            const form = document.getElementById('userForm');
            const title = document.getElementById('modalTitle');
            const userInput = document.getElementById('viciUsername');
            const nameInput = document.getElementById('userName');
            const scoreInput = document.getElementById('generalScore');
            const goalInput = document.getElementById('callGoal');
            const commentsInput = document.getElementById('generalComments');

            // Limpiar formulario y resetear estado
            form.reset();
            userInput.disabled = false;
            
            if (userKey) {
                // Modo editar
                title.textContent = `Editar Usuario: ${userKey}`;
                const userData = usersDB[userKey].data;
                userInput.value = userKey;
                userInput.disabled = true; // No permitir cambiar la clave de usuario
                nameInput.value = userData.name;
                scoreInput.value = userData.generalScore;
                goalInput.value = userData.callGoal;
                commentsInput.value = userData.generalComments;
            } else {
                // Modo añadir
                title.textContent = 'Añadir Nuevo Usuario';
            }
            
            modal.classList.remove('hidden');
            
            // Manejar el envío del formulario
            form.onsubmit = (e) => {
                e.preventDefault();
                const newUserKey = userInput.value.trim();
                const newUserData = {
                    name: nameInput.value,
                    generalScore: parseInt(scoreInput.value),
                    callGoal: parseInt(goalInput.value),
                    generalComments: commentsInput.value,
                    // Se pueden añadir más campos aquí
                };
                
                // Si es un nuevo usuario, crear el objeto completo
                if (!userKey) {
                    newUserData.viciCode = `vici-${newUserKey.toLowerCase().replace('usuario', '')}`;
                    // Clonar la estructura de datos del usuario de ejemplo
                    const exampleData = JSON.parse(JSON.stringify(usersDB['Usuario01'].data));
                    newUserData.categories = exampleData.categories;
                    newUserData.trends = exampleData.trends;
                    newUserData.badges = exampleData.badges;
                    newUserData.upcomingBadges = exampleData.upcomingBadges;
                    newUserData.improvementPlan = exampleData.improvementPlan;
                    usersDB[newUserKey] = { role: 'user', data: newUserData };
                } else {
                    // Si es un usuario existente, solo actualizar los campos básicos
                    usersDB[userKey].data.name = newUserData.name;
                    usersDB[userKey].data.generalScore = newUserData.generalScore;
                    usersDB[userKey].data.callGoal = newUserData.callGoal;
                    usersDB[userKey].data.generalComments = newUserData.generalComments;
                }
                
                saveUsersToLocalStorage();
                renderUserTable();
                modal.classList.add('hidden');
            };
            
            // Manejar el botón de cancelar
            document.getElementById('cancelUserButton').onclick = () => {
                modal.classList.add('hidden');
            };
        }

        // Nuevo: Función para mostrar el modal de detalles y edición completa
        function showDetailsModal(userKey) {
            const modal = document.getElementById('detailsModal');
            const form = document.getElementById('detailsForm');
            const userData = usersDB[userKey].data;
            
            // Rellenar el formulario con los datos actuales
            document.getElementById('detailsModalTitle').textContent = `Detalles de ${userData.name}`;
            document.getElementById('detailsName').value = userData.name;
            document.getElementById('detailsGeneralScore').value = userData.generalScore;
            document.getElementById('detailsCallGoal').value = userData.callGoal;
            document.getElementById('detailsGeneralComments').value = userData.generalComments;

            // Rellenar categorías
            const categoriesContainer = document.getElementById('detailsCategoriesContainer');
            categoriesContainer.innerHTML = '';
            userData.categories.forEach(cat => {
                const catDiv = document.createElement('div');
                catDiv.className = 'p-4 border rounded-lg';
                catDiv.innerHTML = `
                    <h5 class="font-semibold mb-2">${cat.name}</h5>
                    <div><label class="block text-sm font-semibold mb-1">Puntaje</label><input type="number" step="0.1" value="${cat.score}" data-category-id="${cat.id}" data-field="score" class="w-full p-2 border rounded-lg"></div>
                    <div><label class="block text-sm font-semibold mt-2 mb-1">Comentarios de Supervisión</label><textarea data-category-id="${cat.id}" data-field="comments.supervision" rows="2" class="w-full p-2 border rounded-lg">${cat.comments.supervision}</textarea></div>
                    <div><label class="block text-sm font-semibold mt-2 mb-1">Comentarios de Calidad</label><textarea data-category-id="${cat.id}" data-field="comments.quality" rows="2" class="w-full p-2 border rounded-lg">${cat.comments.quality}</textarea></div>
                    <h6 class="font-bold text-sm mt-4 mb-2">Criterios</h6>
                    <div class="space-y-2">
                        ${cat.criteria.map((crit, index) => `
                            <div>
                                <label class="block text-xs font-semibold mb-1">${crit.name}</label>
                                <input type="number" step="0.1" value="${crit.score}" data-category-id="${cat.id}" data-criteria-index="${index}" class="w-full p-2 border rounded-lg">
                            </div>
                        `).join('')}
                    </div>
                `;
                categoriesContainer.appendChild(catDiv);
            });

            // Rellenar tendencias
            document.getElementById('detailsImprovement').value = userData.trends.improvement;
            document.getElementById('detailsCriticalArea').value = userData.trends.criticalArea;
            
            const trendsContainer = document.getElementById('detailsTrendsContainer');
            trendsContainer.innerHTML = '';

            // Generar campos de edición para los valores de la gráfica de líneas
            Object.keys(userData.trends.scores).forEach(categoryKey => {
                const categoryName = userData.categories.find(c => c.id === categoryKey)?.name || categoryKey;
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'p-4 border rounded-lg';
                categoryDiv.innerHTML = `<h5 class="font-bold mb-4">${categoryName}</h5>`;
                
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2';

                userData.trends.scores[categoryKey].forEach((score, index) => {
                    const month = monthNames[index];
                    const inputDiv = document.createElement('div');
                    inputDiv.innerHTML = `
                        <label class="block text-sm font-semibold mb-1">${month}</label>
                        <input type="number" step="1" value="${score}" data-category-id="${categoryKey}" data-month-index="${index}" class="w-full p-2 border rounded-lg text-sm">
                    `;
                    gridDiv.appendChild(inputDiv);
                });
                categoryDiv.appendChild(gridDiv);
                trendsContainer.appendChild(categoryDiv);
            });

            // Rellenar insignias
            const badgesContainer = document.getElementById('detailsBadgesContainer');
            badgesContainer.innerHTML = `
                <h6 class="font-bold text-sm mb-2">Obtenidas</h6>
                ${userData.badges.map((badge, index) => `
                    <div class="flex items-center space-x-2">
                        <input type="text" value="${badge.title}" data-badge-index="${index}" data-field="title" class="w-1/2 p-2 border rounded-lg">
                        <input type="text" value="${badge.description}" data-badge-index="${index}" data-field="description" class="w-1/2 p-2 border rounded-lg">
                    </div>
                `).join('')}
                <h6 class="font-bold text-sm mt-4 mb-2">Próximas Insignias</h6>
                <label class="block text-sm font-semibold mb-1">Fortalezas</label>
                <textarea id="detailsStrengths" rows="2" class="w-full p-2 border rounded-lg">${userData.upcomingBadges.strengths.join('\n')}</textarea>
                <label class="block text-sm font-semibold mt-2 mb-1">Oportunidades</label>
                <textarea id="detailsOpportunities" rows="2" class="w-full p-2 border rounded-lg">${userData.upcomingBadges.opportunities.join('\n')}</textarea>
            `;

            // Rellenar plan de mejora
            document.getElementById('detailsImprovementInstructions').value = userData.improvementPlan.instructions;
            document.getElementById('detailsImprovementLink').value = userData.improvementPlan.link;

            // Mostrar el modal
            modal.classList.remove('hidden');
            
            // Manejar el envío del formulario de detalles
            form.onsubmit = (e) => {
                e.preventDefault();
                
                // Actualizar los datos generales
                userData.name = document.getElementById('detailsName').value;
                userData.generalScore = parseInt(document.getElementById('detailsGeneralScore').value);
                userData.callGoal = parseInt(document.getElementById('detailsCallGoal').value);
                userData.generalComments = document.getElementById('detailsGeneralComments').value;

                // Actualizar categorías y criterios
                userData.categories.forEach(cat => {
                    cat.score = parseFloat(document.querySelector(`[data-category-id="${cat.id}"][data-field="score"]`).value);
                    cat.comments.supervision = document.querySelector(`[data-category-id="${cat.id}"][data-field="comments.supervision"]`).value;
                    cat.comments.quality = document.querySelector(`[data-category-id="${cat.id}"][data-field="comments.quality"]`).value;
                    cat.criteria.forEach((crit, index) => {
                        const input = document.querySelector(`[data-category-id="${cat.id}"][data-criteria-index="${index}"]`);
                        crit.score = parseFloat(input.value);
                    });
                });

                // Actualizar tendencias
                userData.trends.improvement = document.getElementById('detailsImprovement').value;
                userData.trends.criticalArea = document.getElementById('detailsCriticalArea').value;
                
                // Actualizar los puntajes de la gráfica
                document.querySelectorAll('#detailsTrendsContainer input').forEach(input => {
                    const categoryId = input.getAttribute('data-category-id');
                    const monthIndex = parseInt(input.getAttribute('data-month-index'));
                    userData.trends.scores[categoryId][monthIndex] = parseFloat(input.value);
                });
                
                // Actualizar insignias
                document.querySelectorAll('#detailsBadgesContainer input').forEach(input => {
                    const index = parseInt(input.getAttribute('data-badge-index'));
                    const field = input.getAttribute('data-field');
                    if(field && !isNaN(index)) { // Asegurar que es un campo de insignia
                        userData.badges[index][field] = input.value;
                    }
                });
                userData.upcomingBadges.strengths = document.getElementById('detailsStrengths').value.split('\n').map(s => s.trim()).filter(s => s);
                userData.upcomingBadges.opportunities = document.getElementById('detailsOpportunities').value.split('\n').map(o => o.trim()).filter(o => o);

                // Actualizar plan de mejora
                userData.improvementPlan.instructions = document.getElementById('detailsImprovementInstructions').value;
                userData.improvementPlan.link = document.getElementById('detailsImprovementLink').value;

                // Guardar los cambios en la base de datos y la persistencia
                saveUsersToLocalStorage();
                renderUserTable(); // Actualizar la tabla en el panel de admin
                modal.classList.add('hidden');
            };
        }
        
        // Función para eliminar un usuario
        function deleteUser(userKey) {
            delete usersDB[userKey];
            saveUsersToLocalStorage();
            renderUserTable();
        }

        // Función para vaciar todos los datos de los usuarios (excepto admin)
        function clearAllUserData() {
            const adminData = usersDB['admin'];
            usersDB = { 'admin': adminData };
            saveUsersToLocalStorage();
            renderUserTable();
            document.getElementById('clearTableModal').classList.add('hidden');
            alertMessage('✅ Tabla vaciada exitosamente.', 'green');
        }
        
        // Función para mostrar mensajes de alerta personalizados
        function alertMessage(message, color) {
            const alertBox = document.createElement('div');
            alertBox.textContent = message;
            alertBox.className = `fixed top-4 right-4 p-4 rounded-lg text-white shadow-lg transition-all duration-300 transform translate-x-full z-20 ${color === 'green' ? 'bg-green-500' : 'bg-red-500'}`;
            document.body.appendChild(alertBox);

            setTimeout(() => {
                alertBox.classList.remove('translate-x-full');
                alertBox.style.transform = 'translateX(0)';
            }, 10);

            setTimeout(() => {
                alertBox.style.transform = 'translateX(100%)';
                setTimeout(() => alertBox.remove(), 500);
            }, 3000);
        }

        // --- Nuevas funciones para la gestión de categorías ---

        // Función para mostrar el modal de gestión de categorías
        function showCategoryManagementModal() {
            const modal = document.getElementById('categoryManagementModal');
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            // Usamos las categorías del primer usuario para la plantilla
            const categories = usersDB['Usuario01'].data.categories;

            categories.forEach(cat => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'flex items-center justify-between p-4 bg-white rounded-lg shadow-sm';
                categoryDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-xl">${cat.emoji}</span>
                        <span class="font-semibold text-gray-800">${cat.name}</span>
                    </div>
                    <div class="space-x-2">
                        <button class="edit-category-btn bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors duration-200" data-id="${cat.id}">Editar</button>
                        <button class="delete-category-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm transition-colors duration-200" data-id="${cat.id}">Eliminar</button>
                    </div>
                `;
                categoriesList.appendChild(categoryDiv);
            });

            // Añadir listeners para los botones del modal de gestión
            document.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.getAttribute('data-id');
                    showEditCategoryModal(categoryId);
                });
            });

            document.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.getAttribute('data-id');
                    if (confirm(`¿Estás seguro de que deseas eliminar la categoría y sus criterios?`)) {
                        deleteCategory(categoryId);
                    }
                });
            });

            document.getElementById('addCategoryButton').addEventListener('click', () => {
                showEditCategoryModal();
            });

            document.getElementById('closeCategoryModalButton').addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            modal.classList.remove('hidden');
        }

        // Función para mostrar el modal de edición de una categoría
        function showEditCategoryModal(categoryId = null) {
            const categoryManagementModal = document.getElementById('categoryManagementModal');
            const editCategoryModal = document.getElementById('editCategoryModal');
            const editCategoryForm = document.getElementById('editCategoryForm');
            const title = document.getElementById('editCategoryTitle');
            const nameInput = document.getElementById('categoryNameInput');
            const emojiInput = document.getElementById('categoryEmojiInput');
            const criteriaContainer = document.getElementById('criteriaContainer');

            // Limpiar formulario
            editCategoryForm.reset();
            criteriaContainer.innerHTML = '';

            let categoryData = null;
            if (categoryId) {
                title.textContent = 'Editar Categoría';
                categoryData = usersDB['Usuario01'].data.categories.find(cat => cat.id === categoryId);
                nameInput.value = categoryData.name;
                emojiInput.value = categoryData.emoji;
                
                // Rellenar criterios
                if (categoryData.criteria) {
                    categoryData.criteria.forEach((crit, index) => {
                        addCriterionRow(crit.name, index);
                    });
                }
            } else {
                title.textContent = 'Añadir Nueva Categoría';
                // Añadir un criterio por defecto para una nueva categoría
                addCriterionRow('', 0);
            }

            // Ocultar modal de gestión y mostrar modal de edición
            categoryManagementModal.classList.add('hidden');
            editCategoryModal.classList.remove('hidden');

            document.getElementById('addCriterionButton').onclick = () => addCriterionRow();

            editCategoryForm.onsubmit = (e) => {
                e.preventDefault();
                const newCategoryName = nameInput.value;
                const newCategoryEmoji = emojiInput.value;
                
                // Recolectar criterios del formulario
                const newCriteria = [];
                document.querySelectorAll('.criterion-row').forEach(row => {
                    const name = row.querySelector('input').value;
                    if (name) {
                         newCriteria.push({ name: name, score: 10 }); // El puntaje por defecto para un nuevo criterio será 10
                    }
                });

                // Si es una categoría nueva
                if (!categoryId) {
                    const newId = newCategoryName.toLowerCase().replace(/\s+/g, '');
                    const newCategory = {
                        id: newId,
                        name: newCategoryName,
                        emoji: newCategoryEmoji,
                        score: 0,
                        comments: { supervision: '', quality: '' },
                        criteria: newCriteria,
                        color: 'bg-blue-200' // Color por defecto
                    };
                    addCategory(newCategory);
                } else {
                    // Si es una categoría existente
                    const updatedCategory = { ...categoryData, name: newCategoryName, emoji: newCategoryEmoji, criteria: newCriteria };
                    updateCategory(updatedCategory);
                }

                // Ocultar modal de edición y mostrar modal de gestión actualizado
                editCategoryModal.classList.add('hidden');
                showCategoryManagementModal();
            };

            document.getElementById('cancelEditCategoryButton').onclick = () => {
                editCategoryModal.classList.add('hidden');
                showCategoryManagementModal();
            };
        }

        // Función auxiliar para añadir una fila de criterio al modal
        function addCriterionRow(name = '', index = Date.now()) {
            const criteriaContainer = document.getElementById('criteriaContainer');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'criterion-row flex items-center space-x-2';
            rowDiv.innerHTML = `
                <input type="text" placeholder="Nombre del criterio" value="${name}" class="w-full p-2 border rounded-lg" required>
                <button type="button" class="delete-criterion-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg text-sm">X</button>
            `;
            criteriaContainer.appendChild(rowDiv);

            rowDiv.querySelector('.delete-criterion-btn').onclick = () => {
                if (confirm('¿Estás seguro de que deseas eliminar este criterio?')) {
                    rowDiv.remove();
                }
            };
        }

        // Lógica para añadir una nueva categoría a todos los usuarios
        function addCategory(newCategory) {
            const trendCategories = Object.keys(usersDB['Usuario01'].data.trends.scores);
            // Si es una de las categorías principales, agregar un array vacío de tendencias
            if (['retencion', 'reincorporacion', 'procesos', 'general'].includes(newCategory.id)) {
                newCategory.trends = Array(12).fill(0);
            }
        
            Object.keys(usersDB).forEach(userKey => {
                if (usersDB[userKey].role === 'user') {
                    // Clonar la nueva categoría para cada usuario
                    const clonedCategory = JSON.parse(JSON.stringify(newCategory));
                    usersDB[userKey].data.categories.push(clonedCategory);
                    // Si la nueva categoría es una de las principales, también inicializamos los datos de tendencias para ese usuario
                    if (trendCategories.includes(clonedCategory.id)) {
                        usersDB[userKey].data.trends.scores[clonedCategory.id] = Array(12).fill(0);
                    }
                }
            });
            saveUsersToLocalStorage();
        }

        // Lógica para actualizar una categoría en todos los usuarios
        function updateCategory(updatedCategory) {
            Object.keys(usersDB).forEach(userKey => {
                if (usersDB[userKey].role === 'user') {
                    const categories = usersDB[userKey].data.categories;
                    const index = categories.findIndex(cat => cat.id === updatedCategory.id);
                    if (index !== -1) {
                        // Actualizar los campos que el administrador puede modificar
                        categories[index].name = updatedCategory.name;
                        categories[index].emoji = updatedCategory.emoji;
                        categories[index].criteria = updatedCategory.criteria;
                    }
                }
            });
            saveUsersToLocalStorage();
        }

        // Lógica para eliminar una categoría de todos los usuarios
        function deleteCategory(categoryId) {
            Object.keys(usersDB).forEach(userKey => {
                if (usersDB[userKey].role === 'user') {
                    usersDB[userKey].data.categories = usersDB[userKey].data.categories.filter(cat => cat.id !== categoryId);
                }
            });
            // Eliminar también de las tendencias si aplica
            const trendCategories = ['retencion', 'reincorporacion', 'procesos', 'general'];
            if (trendCategories.includes(categoryId)) {
                Object.keys(usersDB).forEach(userKey => {
                    if (usersDB[userKey].role === 'user') {
                        delete usersDB[userKey].data.trends.scores[categoryId];
                    }
                });
            }
            saveUsersToLocalStorage();
            showCategoryManagementModal();
        }

        // --- Fin de las nuevas funciones ---

        // Función para renderizar el dashboard principal
        function renderDashboard() {
            if (!currentUser || currentUser.role !== 'user') return;

            const userData = currentUser.data;

            appContainer.innerHTML = `
                <div class="bg-white/90 p-8 rounded-3xl shadow-lg w-full max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Resultados de Evaluación 📊</h1>
                        <button id="backButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-xl shadow-md transition-all duration-300">
                            ← Volver
                        </button>
                    </div>
                    <p class="text-lg text-gray-600 mb-6">Hola, ${userData.name}</p>

                    <!-- Pestañas de navegación -->
                    <div class="flex flex-wrap sm:flex-nowrap justify-center sm:justify-start mb-6 border-b border-gray-200">
                        <button class="tab-button active px-4 py-2 text-sm sm:text-base font-semibold border-b-2 border-transparent hover:border-blue-500 rounded-t-lg focus:outline-none" data-tab="general">Resumen General 📈</button>
                        <button class="tab-button px-4 py-2 text-sm sm:text-base font-semibold border-b-2 border-transparent hover:border-blue-500 rounded-t-lg focus:outline-none" data-tab="trends">Tendencias 📊</button>
                        <button class="tab-button px-4 py-2 text-sm sm:text-base font-semibold border-b-2 border-transparent hover:border-blue-500 rounded-t-lg focus:outline-none" data-tab="badges">Insignias 🎖️</button>
                        <button class="tab-button px-4 py-2 text-sm sm:text-base font-semibold border-b-2 border-transparent hover:border-blue-500 rounded-t-lg focus:outline-none" data-tab="plan">Plan de Mejora 📝</button>
                    </div>

                    <!-- Contenedores de contenido de las pestañas -->
                    <div id="tabContent">
                        <!-- Contenido dinámico de las pestañas -->
                    </div>
                </div>
            `;

            document.getElementById('backButton').addEventListener('click', renderLogin);

            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContent = document.getElementById('tabContent');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active', 'bg-[#2a6aff]', 'text-white'));
                    button.classList.add('active', 'bg-[#2a6aff]', 'text-white');
                    const tab = button.getAttribute('data-tab');
                    renderTabContent(tab);
                });
            });

            // Renderiza la pestaña inicial
            renderTabContent('general');

            // Lógica para renderizar el contenido de cada pestaña
            function renderTabContent(tabName) {
                let contentHTML = '';
                if (chartInstance) {
                    chartInstance.destroy(); // Destruye el gráfico anterior si existe
                }

                switch (tabName) {
                    case 'general':
                        contentHTML = `
                            <!-- Resumen General -->
                            <div class="space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="p-6 bg-blue-100 rounded-2xl shadow-md">
                                        <h3 class="font-bold text-lg mb-2 flex items-center">Calificación General 🌟</h3>
                                        <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden">
                                            <div class="bg-[#2a6aff] h-4 rounded-full transition-all duration-700 ease-in-out" style="width: ${userData.generalScore}%;"></div>
                                            <span class="absolute top-0 left-1/2 -translate-x-1/2 font-bold text-xs text-white">${userData.generalScore}%</span>
                                        </div>
                                    </div>
                                    <div class="p-6 bg-orange-100 rounded-2xl shadow-md">
                                        <h3 class="font-bold text-lg mb-2 flex items-center">Meta de Llamadas 📞</h3>
                                        <div class="w-full bg-gray-200 rounded-full h-4 relative overflow-hidden">
                                            <div class="bg-[#ff8500] h-4 rounded-full transition-all duration-700 ease-in-out" style="width: ${userData.callGoal}%;"></div>
                                            <span class="absolute top-0 left-1/2 -translate-x-1/2 font-bold text-xs text-white">${userData.callGoal}%</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tarjetas de Categorías -->
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
                                    ${userData.categories.map(cat => `
                                        <div class="card p-6 ${cat.color} flex flex-col">
                                            <div class="flex items-center justify-between mb-4">
                                                <h3 class="font-bold text-lg text-gray-800 flex items-center">${cat.name} ${cat.emoji}</h3>
                                                <div class="w-12 h-12 flex items-center justify-center font-bold text-lg rounded-full border-4 ${cat.score >= 7.0 ? 'border-green-500 text-green-700' : 'border-red-500 text-red-700'} bg-white">
                                                    ${cat.score.toFixed(1)}
                                                </div>
                                            </div>
                                            <!-- Pestañas de Comentarios -->
                                            <div class="flex justify-center mb-4">
                                                <button class="tab-button-internal supervision-tab active px-4 py-2 text-xs font-semibold rounded-full border border-gray-400 bg-white" data-category="${cat.id}" data-type="supervision">Supervisión</button>
                                                <button class="tab-button-internal quality-tab px-4 py-2 text-xs font-semibold rounded-full border border-gray-400 ml-2" data-category="${cat.id}" data-type="quality">Calidad</button>
                                            </div>
                                            <div class="flex-grow">
                                                <p id="comment-${cat.id}" class="text-sm text-gray-700 text-center italic">${cat.comments.supervision}</p>
                                            </div>

                                            <!-- Sección de Criterios (Expandible) -->
                                            <div class="mt-4">
                                                <button class="criteria-toggle flex items-center justify-between w-full px-4 py-2 bg-gray-300/50 hover:bg-gray-300 rounded-xl transition-colors duration-300" data-target="#criteria-list-${cat.id}">
                                                    <span class="font-semibold text-sm">Criterios de Calificación</span>
                                                    <svg class="criteria-button w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                    </svg>
                                                </button>
                                                <ul id="criteria-list-${cat.id}" class="mt-2 space-y-1 text-sm text-gray-600 hidden">
                                                    ${cat.criteria.map(crit => `
                                                        <li class="flex justify-between items-center">
                                                            <span>• ${crit.name}</span>
                                                            <span class="font-bold">${crit.score.toFixed(1)}</span>
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="mt-8 p-6 bg-white/90 rounded-2xl shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">Comentarios generales del Supervisor 📝</h3>
                                    <p class="text-gray-700">${userData.generalComments}</p>
                                </div>
                                <div class="flex justify-center mt-6">
                                    <a href="https://www.google.com" target="_blank" class="bg-[#ff8500] hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-300 hover:scale-105 active:scale-95">
                                        Detalles de Evaluación 🔍
                                    </a>
                                </div>
                            </div>
                        `;
                        break;

                    case 'trends':
                        const monthlyTrendEmoji = (trend) => trend === 'up' ? '📈' : '📉';
                        contentHTML = `
                            <!-- Tendencias -->
                            <div class="space-y-6">
                                <div class="p-6 bg-gray-100 rounded-2xl shadow-md">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-xl font-bold text-gray-800">Gráfica Anual de Desempeño 🗓️</h3>
                                        <div class="flex space-x-2">
                                            <button id="selectAllButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold text-sm py-1 px-3 rounded-full transition-colors duration-300">Seleccionar Todo</button>
                                            <button id="deselectAllButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold text-sm py-1 px-3 rounded-full transition-colors duration-300">Desactivar Todo</button>
                                        </div>
                                    </div>
                                    <div class="relative h-96 w-full">
                                        <canvas id="performanceChart"></canvas>
                                    </div>
                                    <div id="chartCheckboxes" class="flex flex-wrap justify-center mt-4 gap-2"></div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="p-6 bg-white rounded-2xl shadow-md text-center">
                                        <h4 class="font-semibold text-gray-600">Hace 2 Meses</h4>
                                        <p class="text-3xl font-bold mt-2">${userData.trends.monthly['month-2'].score} ${monthlyTrendEmoji(userData.trends.monthly['month-2'].trend)}</p>
                                    </div>
                                    <div class="p-6 bg-white rounded-2xl shadow-md text-center">
                                        <h4 class="font-semibold text-gray-600">Mes Anterior</h4>
                                        <p class="text-3xl font-bold mt-2">${userData.trends.monthly['month-1'].score} ${monthlyTrendEmoji(userData.trends.monthly['month-1'].trend)}</p>
                                    </div>
                                    <div class="p-6 bg-white rounded-2xl shadow-md text-center">
                                        <h4 class="font-semibold text-gray-600">Mes Actual</h4>
                                        <p class="text-3xl font-bold mt-2">${userData.trends.monthly['current'].score} ${monthlyTrendEmoji(userData.trends.monthly['current'].trend)}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="p-6 bg-green-100 rounded-2xl shadow-md">
                                        <h4 class="font-bold text-lg mb-2 flex items-center">La Mayor Mejora ✅</h4>
                                        <p class="text-sm text-gray-700">${userData.trends.improvement}</p>
                                    </div>
                                    <div class="p-6 bg-red-100 rounded-2xl shadow-md">
                                        <h4 class="font-bold text-lg mb-2 flex items-center">Área Crítica ⚠️</h4>
                                        <p class="text-sm text-gray-700">${userData.trends.criticalArea}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;

                    case 'badges':
                        contentHTML = `
                            <!-- Insignias -->
                            <div class="space-y-6">
                                <div class="p-6 bg-white rounded-2xl shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">Insignias Obtenidas 🌟</h3>
                                    <ul class="space-y-4">
                                        ${userData.badges.map(badge => `
                                            <li>
                                                <h4 class="font-bold text-lg text-gray-800">${badge.title}</h4>
                                                <p class="text-gray-600 text-sm mt-1">${badge.description}</p>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                                <div class="p-6 bg-white rounded-2xl shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">Próximas Insignias 🚀</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <h4 class="font-semibold text-gray-700 mb-2">Fortalezas</h4>
                                            <ul class="list-disc list-inside space-y-1 text-gray-600">
                                                ${userData.upcomingBadges.strengths.map(strength => `<li>${strength}</li>`).join('')}
                                            </ul>
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-700 mb-2">Áreas de Oportunidad</h4>
                                            <ul class="list-disc list-inside space-y-1 text-gray-600">
                                                ${userData.upcomingBadges.opportunities.map(opportunity => `<li>${opportunity}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;

                    case 'plan':
                        contentHTML = `
                            <!-- Plan de Mejora -->
                            <div class="space-y-6">
                                <div class="p-6 bg-white rounded-2xl shadow-md">
                                    <h3 class="text-xl font-bold text-gray-800 mb-4">Plan de Mejora 🎯</h3>
                                    <p class="text-gray-700 leading-relaxed">${userData.improvementPlan.instructions}</p>
                                </div>
                                <div class="flex justify-center mt-6">
                                    <a href="${userData.improvementPlan.link}" target="_blank" class="bg-[#ff8500] hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-300 hover:scale-105 active:scale-95">
                                        Crear mi Plan de Mejora ✍️
                                    </a>
                                </div>
                            </div>
                        `;
                        break;
                }

                tabContent.innerHTML = contentHTML;

                // Lógica de los gráficos para la pestaña de tendencias
                if (tabName === 'trends') {
                    const ctx = document.getElementById('performanceChart').getContext('2d');
                    const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    const categoryColors = {
                        'retencion': '#3b82f6',
                        'reincorporacion': '#10b981',
                        'procesos': '#8b5cf6',
                        'general': '#6b7280'
                    };

                    const createChart = (datasets) => {
                        if (chartInstance) {
                            chartInstance.destroy();
                        }
                        chartInstance = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: false },
                                    tooltip: { mode: 'index', intersect: false }
                                },
                                scales: {
                                    y: {
                                        min: 70, max: 100,
                                        title: { display: true, text: 'Puntaje' },
                                        grid: { color: 'rgba(200, 200, 200, 0.5)' }
                                    },
                                    x: {
                                        title: { display: true, text: 'Módulo' },
                                        grid: { display: false }
                                    }
                                }
                            }
                        });
                    };

                    const chartCheckboxes = document.getElementById('chartCheckboxes');
                    const allCategories = Object.keys(userData.trends.scores);
                    const datasets = [];

                    allCategories.forEach(cat => {
                        const color = categoryColors[cat] || '#000000';
                        const isChecked = true; // Por defecto todos seleccionados
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `chart-cb-${cat}`;
                        checkbox.value = cat;
                        checkbox.checked = isChecked;
                        checkbox.className = 'mr-1';

                        const label = document.createElement('label');
                        label.htmlFor = `chart-cb-${cat}`;
                        label.className = 'text-sm font-semibold flex items-center cursor-pointer';
                        label.style.color = color;
                        label.textContent = userData.categories.find(c => c.id === cat)?.name || cat;

                        const span = document.createElement('span');
                        span.className = 'w-3 h-3 rounded-full mr-1';
                        span.style.backgroundColor = color;
                        label.prepend(span);

                        const div = document.createElement('div');
                        div.className = 'flex items-center';
                        div.appendChild(checkbox);
                        div.appendChild(label);

                        chartCheckboxes.appendChild(div);

                        if (isChecked) {
                            datasets.push({
                                label: userData.categories.find(c => c.id === cat)?.name || cat,
                                data: userData.trends.scores[cat],
                                borderColor: color,
                                backgroundColor: color,
                                borderWidth: 2,
                                fill: false,
                                tension: 0.4,
                                pointRadius: 5
                            });
                        }

                        checkbox.addEventListener('change', () => {
                            updateChartDatasets();
                        });
                    });

                    createChart(datasets);

                    const updateChartDatasets = () => {
                        const newDatasets = [];
                        const checkboxes = document.querySelectorAll('#chartCheckboxes input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            if (cb.checked) {
                                const cat = cb.value;
                                const color = categoryColors[cat] || '#000000';
                                newDatasets.push({
                                    label: userData.categories.find(c => c.id === cat)?.name || cat,
                                    data: userData.trends.scores[cat],
                                    borderColor: color,
                                    backgroundColor: color,
                                    borderWidth: 2,
                                    fill: false,
                                    tension: 0.4,
                                    pointRadius: 5
                                });
                            }
                        });
                        chartInstance.data.datasets = newDatasets;
                        chartInstance.update();
                    };

                    document.getElementById('selectAllButton').addEventListener('click', () => {
                        document.querySelectorAll('#chartCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
                        updateChartDatasets();
                    });

                    document.getElementById('deselectAllButton').addEventListener('click', () => {
                        document.querySelectorAll('#chartCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
                        updateChartDatasets();
                    });
                }
                
                // Lógica de los criterios de evaluación expandibles
                const criteriaToggles = document.querySelectorAll('.criteria-toggle');
                criteriaToggles.forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const targetId = toggle.getAttribute('data-target');
                        const targetList = document.querySelector(targetId);
                        const arrowIcon = toggle.querySelector('.criteria-button');
                        
                        if (targetList.classList.contains('hidden')) {
                            targetList.classList.remove('hidden');
                            arrowIcon.classList.add('rotate');
                        } else {
                            targetList.classList.add('hidden');
                            arrowIcon.classList.remove('rotate');
                        }
                    });
                });

                // Lógica para las tarjetas de la pestaña "Resumen General"
                const categoryTabs = document.querySelectorAll('.tab-button-internal');
                categoryTabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const categoryId = e.target.getAttribute('data-category');
                        const type = e.target.getAttribute('data-type');
                        const card = e.target.closest('.card');
                        
                        // Eliminar la clase activa de todos los botones de la misma tarjeta
                        card.querySelectorAll('.tab-button-internal').forEach(btn => {
                            btn.classList.remove('active', 'bg-white', 'text-gray-800');
                            btn.style.backgroundColor = '';
                            btn.style.borderColor = '';
                        });
                        
                        // Obtener el color de la tarjeta
                        const cardColorClass = card.classList.item(2);
                        const cardColor = cardColorClass === 'bg-indigo-200' ? '#c7d2fe' : 
                                          cardColorClass === 'bg-green-200' ? '#d1fae5' :
                                          cardColorClass === 'bg-purple-200' ? '#e9d5ff' :
                                          cardColorClass === 'bg-yellow-200' ? '#fef9c3' :
                                          cardColorClass === 'bg-pink-200' ? '#fce7f3' :
                                          cardColorClass === 'bg-gray-200' ? '#e5e7eb' :
                                          cardColorClass === 'bg-lime-200' ? '#e2e8f0' : '#ffffff';

                        // Actualizar la clase activa del botón clickeado
                        e.target.classList.add('active', 'bg-white', 'text-gray-800');
                        e.target.style.backgroundColor = cardColor;
                        e.target.style.borderColor = '#2a6aff';

                        // Actualizar el comentario
                        const categoryData = userData.categories.find(cat => cat.id === categoryId);
                        const commentElement = document.getElementById(`comment-${categoryId}`);
                        if (categoryData && commentElement) {
                            commentElement.textContent = categoryData.comments[type];
                        }
                    });
                });
            }
        }

        // Cargar datos y renderizar la pantalla inicial al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            loadUsersFromLocalStorage();
            renderLogin();
        });
    </script>

</body>
</html>
